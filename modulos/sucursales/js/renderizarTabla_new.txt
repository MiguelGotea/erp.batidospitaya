// Renderizar tabla semanal (7 columnas: Lunes-Domingo)
function renderizarTabla() {
    const nombreDias = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
    const hoy = new Date();
    hoy.setHours(0, 0, 0, 0);
    
    // Filter products that have at least one delivery day configured this week
    const diasSemanaEntrega = fechasEntrega.map(d => d.diaSemanaEntrega);
    const productosFiltrados = productos.filter(producto => {
        return producto.dias_entrega.some(dia => diasSemanaEntrega.includes(dia));
    });
    
    if (productosFiltrados.length === 0) {
        $('#productos-container').html(`
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                No hay productos configurados para entregas esta semana.
            </div>
        `);
        return;
    }
    
    // Build table header
    let html = `
        <div class="table-responsive">
            <table class="table table-bordered pedidos-table">
                <thead>
                    <tr>
                        <th style="width: 20%">Producto</th>
    `;
    
    // Generate column headers for each day
    fechasEntrega.forEach((diaInfo, index) => {
        const nombreDia = nombreDias[index];
        const nombreEntrega = nombreDias[(index + 1) % 7];
        const esHoy = diaInfo.pedido.toDateString() === hoy.toDateString();
        
        let contadorHTML = '';
        let claseColumna = 'day-column';
        
        if (esHoy) {
            claseColumna += ' current-day-column';
            const beforeDeadline = verificarHoraLimite();
            
            if (beforeDeadline) {
                const { hours, minutes, seconds } = calcularTiempoRestante();
                const horasStr = String(hours).padStart(2, '0');
                const minutosStr = String(minutes).padStart(2, '0');
                const segundosStr = String(seconds).padStart(2, '0');
                
                const totalMinutes = hours * 60 + minutes;
                let claseContador = 'countdown-normal';
                if (totalMinutes < 30) {
                    claseContador = 'countdown-critical';
                } else if (totalMinutes < 120) {
                    claseContador = 'countdown-warning';
                }
                
                contadorHTML = `<br><small class="countdown-timer ${claseContador}">‚è∞ ${horasStr}:${minutosStr}:${segundosStr}</small>`;
            } else {
                contadorHTML = '<br><small class="countdown-expired">üîí BLOQUEADO</small>';
            }
        }
        
        html += `
            <th class="text-center ${claseColumna}">
                ${nombreDia}<br>
                <small class="delivery-label">‚Üí ${nombreEntrega}</small>
                ${contadorHTML}
            </th>
        `;
    });
    
    html += `
                    </tr>
                </thead>
                <tbody>
    `;
    
    // Generate rows for each product
    productosFiltrados.forEach(producto => {
        const isInactive = producto.status === 'inactivo';
        
        html += `
            <tr ${isInactive ? 'class="inactive-product"' : ''}>
                <td>
                    <strong>${producto.nombre_producto}</strong>
                    ${isInactive ? '<br><span class="badge bg-secondary">Inactivo</span>' : ''}
                </td>
        `;
        
        // Generate cell for each day
        fechasEntrega.forEach((diaInfo, index) => {
            const esHoy = diaInfo.pedido.toDateString() === hoy.toDateString();
            const beforeDeadline = esHoy ? verificarHoraLimite() : true;
            const tieneConfig = producto.dias_entrega.includes(diaInfo.diaSemanaEntrega);
            
            // Get existing order for this day
            const fechaEntregaSQL = formatearFechaSQL(diaInfo.entrega);
            const key = `${producto.id_producto}_${fechaEntregaSQL}`;
            const pedido = pedidos[key];
            const cantidad = pedido ? pedido.cantidad : '';
            const fechaHora = pedido ? pedido.fecha_hora_reportada : null;
            
            const habilitado = tieneConfig && beforeDeadline && !isInactive;
            
            html += `
                <td class="day-cell ${habilitado ? 'enabled' : 'disabled'} ${cantidad ? 'has-order' : ''}"
                    data-producto-id="${producto.id_producto}"
                    data-dia-index="${index}"
                    data-fecha-entrega="${fechaEntregaSQL}"
                    data-fecha-hora="${fechaHora || ''}"
                    ${habilitado && puedeEditar ? `onclick="editarCantidad(this)"` : ''}>
                    ${!tieneConfig || !beforeDeadline || isInactive ? 
                        (tieneConfig && !beforeDeadline ? 'üîí' : '-') : 
                        (cantidad ? 
                            `<span class="cantidad-display">${cantidad}</span>` : 
                            '<span class="text-muted">-</span>'
                        )
                    }
                </td>
            `;
        });
        
        html += `
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    $('#productos-container').html(html);
    
    // Add tooltips
    $('.day-cell[data-fecha-hora]').each(function () {
        const fechaHora = $(this).data('fecha-hora');
        if (fechaHora) {
            $(this).attr('title', `Registrado: ${formatearFechaHora(fechaHora)}`);
        }
    });
}
