name: ğŸ§ª Test Deploy Manual

on:
  workflow_dispatch:  # Permite ejecuciÃ³n manual
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/test-deploy.yml'

jobs:
  test-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ”‘ Configurar SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.HOSTINGER_GIT_SSH_KEY }}
        
    - name: ğŸ› ï¸ Configurar Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
    - name: ğŸ” Verificar configuraciÃ³n
      run: |
        echo "=== CONFIGURACIÃ“N ==="
        echo "ğŸ”‘ Clave SSH cargada correctamente"
        echo "ğŸ“ Directorio actual: $(pwd)"
        echo "ğŸ“¦ Archivos en modulos/mantenimiento:"
        ls -la modulos/mantenimiento/ || echo "No existe la carpeta"
        
    - name: ğŸ§ª Test conexiÃ³n Git Hostinger
      run: |
        echo "ğŸ§ª Probando conexiÃ³n con Hostinger Git..."
        
        # Agregar known hosts
        mkdir -p ~/.ssh
        ssh-keyscan -p 22 git-ssh.eu >> ~/.ssh/known_hosts 2>/dev/null
        
        # Test de conexiÃ³n SSH
        ssh -o StrictHostKeyChecking=no -T u838374897@git-ssh.eu && \
          echo "âœ… ConexiÃ³n SSH exitosa" || \
          echo "âš ï¸ ConexiÃ³n SSH fallÃ³ pero puede ser normal"
          
    - name: ğŸ§ª Clonar repositorio Hostinger
      run: |
        echo "ğŸ§ª Intentando clonar repositorio de Hostinger..."
        
        # Clonar en modo prueba
        timeout 30 git clone u838374897@git-ssh.eu:main-hosting.eu.git hostinger-test 2>&1 | head -20
        
        if [ -d "hostinger-test" ]; then
          echo "âœ… ClonaciÃ³n exitosa"
          echo "ğŸ“ Contenido del repositorio:"
          ls -la hostinger-test/ | head -10
        else
          echo "âŒ No se pudo clonar el repositorio"
        fi
        
    - name: ğŸ§ª Test push simple
      if: always()  # Se ejecuta aunque falle el paso anterior
      run: |
        echo "ğŸ§ª Probando push simple..."
        
        if [ -d "hostinger-test" ]; then
          cd hostinger-test
          
          # Crear archivo de prueba
          echo "<!-- Test GitHub Actions -->" > test-deploy-$(date +%Y%m%d-%H%M%S).html
          
          # Configurar git
          git config user.name "GitHub Actions Test"
          git config user.email "test@github.com"
          
          # Intentar hacer push
          git add .
          git commit -m "Test deploy $(date)" || echo "No hay cambios"
          git push origin main && echo "âœ… Push exitoso" || echo "âŒ Push fallÃ³"
        else
          echo "âš ï¸ No se puede probar push - repositorio no clonado"
        fi
        
    - name: ğŸ“Š Resultados
      if: always()
      run: |
        echo "=== RESULTADOS DE LA PRUEBA ==="
        echo "ğŸ• Fecha: $(date)"
        echo "ğŸ“ Revisa los pasos anteriores para ver el estado de cada prueba"
        echo ""
        echo "ğŸ“‹ Siguientes pasos:"
        echo "1. Si la clonaciÃ³n funciona: Configurar deploy automÃ¡tico"
        echo "2. Si falla la conexiÃ³n: Verificar la clave SSH en secrets"
        echo "3. Si falla el push: Verificar permisos en Hostinger"
