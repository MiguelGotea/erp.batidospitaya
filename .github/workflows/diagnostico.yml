name: 🧪 Test Deploy Manual

on:
  workflow_dispatch:  # Permite ejecución manual
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/test-deploy.yml'

jobs:
  test-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout código
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: 🔑 Configurar SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.HOSTINGER_GIT_SSH_KEY }}
        
    - name: 🛠️ Configurar Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
    - name: 🔍 Verificar configuración
      run: |
        echo "=== CONFIGURACIÓN ==="
        echo "🔑 Clave SSH cargada correctamente"
        echo "📁 Directorio actual: $(pwd)"
        echo "📦 Archivos en modulos/mantenimiento:"
        ls -la modulos/mantenimiento/ || echo "No existe la carpeta"
        
    - name: 🧪 Test conexión Git Hostinger
      run: |
        echo "🧪 Probando conexión con Hostinger Git..."
        
        # Agregar known hosts
        mkdir -p ~/.ssh
        ssh-keyscan -p 22 git-ssh.eu >> ~/.ssh/known_hosts 2>/dev/null
        
        # Test de conexión SSH
        ssh -o StrictHostKeyChecking=no -T u838374897@git-ssh.eu && \
          echo "✅ Conexión SSH exitosa" || \
          echo "⚠️ Conexión SSH falló pero puede ser normal"
          
    - name: 🧪 Clonar repositorio Hostinger
      run: |
        echo "🧪 Intentando clonar repositorio de Hostinger..."
        
        # Clonar en modo prueba
        timeout 30 git clone u838374897@git-ssh.eu:main-hosting.eu.git hostinger-test 2>&1 | head -20
        
        if [ -d "hostinger-test" ]; then
          echo "✅ Clonación exitosa"
          echo "📁 Contenido del repositorio:"
          ls -la hostinger-test/ | head -10
        else
          echo "❌ No se pudo clonar el repositorio"
        fi
        
    - name: 🧪 Test push simple
      if: always()  # Se ejecuta aunque falle el paso anterior
      run: |
        echo "🧪 Probando push simple..."
        
        if [ -d "hostinger-test" ]; then
          cd hostinger-test
          
          # Crear archivo de prueba
          echo "<!-- Test GitHub Actions -->" > test-deploy-$(date +%Y%m%d-%H%M%S).html
          
          # Configurar git
          git config user.name "GitHub Actions Test"
          git config user.email "test@github.com"
          
          # Intentar hacer push
          git add .
          git commit -m "Test deploy $(date)" || echo "No hay cambios"
          git push origin main && echo "✅ Push exitoso" || echo "❌ Push falló"
        else
          echo "⚠️ No se puede probar push - repositorio no clonado"
        fi
        
    - name: 📊 Resultados
      if: always()
      run: |
        echo "=== RESULTADOS DE LA PRUEBA ==="
        echo "🕐 Fecha: $(date)"
        echo "📝 Revisa los pasos anteriores para ver el estado de cada prueba"
        echo ""
        echo "📋 Siguientes pasos:"
        echo "1. Si la clonación funciona: Configurar deploy automático"
        echo "2. Si falla la conexión: Verificar la clave SSH en secrets"
        echo "3. Si falla el push: Verificar permisos en Hostinger"
