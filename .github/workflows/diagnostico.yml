name: 🔍 Debug SSH Connection 2

on: [workflow_dispatch]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout código
      uses: actions/checkout@v4
      
    - name: 🔑 Configurar SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.HOSTINGER_SSH_KEY }}
        
    - name: 🧪 Test de puerto 65002
      run: |
        echo "🧪 Probando conectividad al puerto 65002..."
        timeout 10 nc -zv ${{ secrets.HOSTINGER_HOST }} 65002 && echo "✅ Puerto 65002 accesible" || echo "❌ Puerto 65002 no accesible"
        
    - name: 📤 Sincronizar con múltiples intentos
      run: |
        echo "🔄 Intentando conexión SSH..."
        
        # Intentar con diferentes configuraciones
        for attempt in 1 2 3; do
          echo "🔹 Intento $attempt..."
          ssh -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              -o BatchMode=yes \
              -p 65002 \
              ${{ secrets.HOSTINGER_USER }}@${{ secrets.HOSTINGER_HOST }} \
              "echo '✅ Conexión SSH exitosa'" && break || echo "⚠️ Intento $attempt falló"
          sleep 2
        done
        
        # Crear carpeta
        ssh -o StrictHostKeyChecking=no \
            -o ConnectTimeout=15 \
            -p 65002 \
            ${{ secrets.HOSTINGER_USER }}@${{ secrets.HOSTINGER_HOST }} \
            "mkdir -p ${{ secrets.HOSTINGER_PATH }}/modulos/mantenimiento"
        
        # Sincronizar
        rsync -avz \
          --delete \
          --progress \
          -e "ssh -o StrictHostKeyChecking=no -o ConnectTimeout=15 -p 65002" \
          ./modulos/mantenimiento/ \
          ${{ secrets.HOSTINGER_USER }}@${{ secrets.HOSTINGER_HOST }}:${{ secrets.HOSTINGER_PATH }}/modulos/mantenimiento/
          
    - name: ✅ Verificar deploy
      run: |
        echo "✅ Deploy completado"