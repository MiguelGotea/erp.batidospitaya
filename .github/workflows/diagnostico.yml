name: üîç Diagn√≥stico de Conexi√≥n Hostinger

on: [workflow_dispatch]

jobs:
  diagnose:
    runs-on: ubuntu-latest
    
    steps:
    - name: üîë Configurar SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.HOSTINGER_SSH_KEY }}
        
    - name: ü©∫ Diagn√≥stico de Red
      run: |
        echo "=== DIAGN√ìSTICO DE CONEXI√ìN HOSTINGER ==="
        
        # Informaci√≥n b√°sica
        echo "1. Informaci√≥n del servidor:"
        echo "   Host: ${{ secrets.HOSTINGER_HOST }}"
        echo "   Usuario: ${{ secrets.HOSTINGER_USER }}"
        
        # Verificar formato de la clave SSH
        echo "2. Verificando clave SSH..."
        if echo "${{ secrets.HOSTINGER_SSH_KEY }}" | grep -q "BEGIN OPENSSH PRIVATE KEY"; then
          echo "   ‚úÖ Formato de clave SSH correcto"
          ssh-keygen -l -f <(echo "${{ secrets.HOSTINGER_SSH_KEY }}") | head -1
        else
          echo "   ‚ùå Formato de clave SSH incorrecto"
        fi
        
        # Verificar DNS
        echo "3. Verificando resoluci√≥n DNS..."
        nslookup ${{ secrets.HOSTINGER_HOST }} 8.8.8.8 || dig ${{ secrets.HOSTINGER_HOST }} @8.8.8.8
        
        # Verificar conectividad b√°sica
        echo "4. Verificando conectividad ICMP (ping)..."
        ping -c 3 ${{ secrets.HOSTINGER_HOST }} || echo "   ‚ùå Ping fallido"
        
        # Verificar puertos comunes
        echo "5. Escaneo de puertos..."
        for port in 21 22 80 443 2222; do
          echo "   Probando puerto $port..."
          timeout 3 nc -zv ${{ secrets.HOSTINGER_HOST }} $port && echo "   ‚úÖ Puerto $port abierto" || echo "   ‚ùå Puerto $port cerrado"
        done
        
        # Verificar con herramientas de red
        echo "6. Verificaci√≥n con curl/wget..."
        curl -I --connect-timeout 5 "https://${{ secrets.HOSTINGER_HOST }}" 2>/dev/null || wget --timeout=5 --spider "https://${{ secrets.HOSTINGER_HOST }}" 2>/dev/null && echo "   ‚úÖ HTTPS accesible" || echo "   ‚ùå HTTPS no accesible"
        
        echo "=== DIAGN√ìSTICO COMPLETADO ==="
