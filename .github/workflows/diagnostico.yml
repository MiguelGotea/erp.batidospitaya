name: ğŸ” Debug SSH Connection 2

on: [workflow_dispatch]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ”‘ Configurar SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.HOSTINGER_SSH_KEY }}
        
    - name: ğŸ§ª Test de puerto 65002
      run: |
        echo "ğŸ§ª Probando conectividad al puerto 65002..."
        timeout 10 nc -zv ${{ secrets.HOSTINGER_HOST }} 65002 && echo "âœ… Puerto 65002 accesible" || echo "âŒ Puerto 65002 no accesible"
        
    - name: ğŸ“¤ Sincronizar con mÃºltiples intentos
      run: |
        echo "ğŸ”„ Intentando conexiÃ³n SSH..."
        
        # Intentar con diferentes configuraciones
        for attempt in 1 2 3; do
          echo "ğŸ”¹ Intento $attempt..."
          ssh -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              -o BatchMode=yes \
              -p 65002 \
              ${{ secrets.HOSTINGER_USER }}@${{ secrets.HOSTINGER_HOST }} \
              "echo 'âœ… ConexiÃ³n SSH exitosa'" && break || echo "âš ï¸ Intento $attempt fallÃ³"
          sleep 2
        done
        
        # Crear carpeta
        ssh -o StrictHostKeyChecking=no \
            -o ConnectTimeout=15 \
            -p 65002 \
            ${{ secrets.HOSTINGER_USER }}@${{ secrets.HOSTINGER_HOST }} \
            "mkdir -p ${{ secrets.HOSTINGER_PATH }}/modulos/mantenimiento"
        
        # Sincronizar
        rsync -avz \
          --delete \
          --progress \
          -e "ssh -o StrictHostKeyChecking=no -o ConnectTimeout=15 -p 65002" \
          ./modulos/mantenimiento/ \
          ${{ secrets.HOSTINGER_USER }}@${{ secrets.HOSTINGER_HOST }}:${{ secrets.HOSTINGER_PATH }}/modulos/mantenimiento/
          
    - name: âœ… Verificar deploy
      run: |
        echo "âœ… Deploy completado"