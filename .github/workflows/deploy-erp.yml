name: üöÄ Deploy ERP - 17 M√≥dulos

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout c√≥digo
      uses: actions/checkout@v4
      
    - name: üîë Configurar SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.HOSTINGER_SSH_KEY }}
        
    - name: üì§ Sincronizar M√≥dulos ERP
      run: |
        # Definir lista de m√≥dulos
        MODULES=(
          "atencioncliente"
          "auxiliaradministrativo"
          "cds"
          "desarrollo"
          "diseno"
          "experienciadigital"
          "gerencia"
          "infraestructura"
          "legal"
          "mantenimiento"
          "marketing"
          "produccion"
          "rh"
          "sistemas"
          "sucursales"
          "tecnicodesarrollohumano"
          "ventas"
        )
        
        for MODULE in "${MODULES[@]}"; do
          if [ -d "./modulos/$MODULE" ]; then
            echo "üîÑ Sincronizando modulos/$MODULE/"
            
            # Crear la carpeta si no existe (incluyendo uploads)
            ssh -o StrictHostKeyChecking=no -p 65002 ${{ secrets.HOSTINGER_USER }}@${{ secrets.HOSTINGER_HOST }} \
              "mkdir -p ${{ secrets.HOSTINGER_PATH }}/modulos/$MODULE && \
               mkdir -p ${{ secrets.HOSTINGER_PATH }}/modulos/$MODULE/uploads"
            
            # Sincronizar la carpeta excluyendo uploads
            rsync -avz \
              --delete \
              --exclude='uploads/' \
              --exclude='.gitignore' \
              --exclude='.agent/' \
              --exclude='core/' \
              --exclude='.scripts/' \
              --exclude='docs/' \
              -e "ssh -o StrictHostKeyChecking=no -p 65002" \
              ./modulos/$MODULE/ \
              ${{ secrets.HOSTINGER_USER }}@${{ secrets.HOSTINGER_HOST }}:${{ secrets.HOSTINGER_PATH }}/modulos/$MODULE/
          else
            echo "‚ö†Ô∏è Saltando modulos/$MODULE/ (no existe localmente)"
          fi
        done
        
    - name: üì§ Sincronizar README ra√≠z
      run: |
        echo "üîÑ Sincronizando README.md..."
        rsync -avz \
          -e "ssh -o StrictHostKeyChecking=no -p 65002" \
          ./README.md \
          ${{ secrets.HOSTINGER_USER }}@${{ secrets.HOSTINGER_HOST }}:${{ secrets.HOSTINGER_PATH }}/
          
    - name: üîß Configurar permisos
      run: |
        # Definir lista de m√≥dulos de nuevo para el paso de permisos
        MODULES=(
          "atencioncliente"
          "auxiliaradministrativo"
          "cds"
          "desarrollo"
          "diseno"
          "experienciadigital"
          "gerencia"
          "infraestructura"
          "legal"
          "mantenimiento"
          "marketing"
          "produccion"
          "rh"
          "sistemas"
          "sucursales"
          "tecnicodesarrollohumano"
          "ventas"
        )
        
        for MODULE in "${MODULES[@]}"; do
          if [ -d "./modulos/$MODULE" ]; then
            echo "üîß Configurando permisos para modulos/$MODULE/"
            ssh -o StrictHostKeyChecking=no -p 65002 ${{ secrets.HOSTINGER_USER }}@${{ secrets.HOSTINGER_HOST }} \
              "chmod -R 755 ${{ secrets.HOSTINGER_PATH }}/modulos/$MODULE/ && \
               find ${{ secrets.HOSTINGER_PATH }}/modulos/$MODULE/ -type f -exec chmod 644 {} \; && \
               chmod -R 755 ${{ secrets.HOSTINGER_PATH }}/modulos/$MODULE/uploads/ && \
               chmod -R 777 ${{ secrets.HOSTINGER_PATH }}/modulos/$MODULE/uploads/ || true"
          else
            echo "‚ö†Ô∏è Saltando permisos para modulos/$MODULE/ (no existe localmente)"
          fi
        done
        
    - name: ‚úÖ Verificar deploy
      run: |
        echo "‚úÖ Deploy completado para los 17 m√≥dulos"
        echo "üìÅ Carpetas 'uploads' excluidas del sync"
        echo "üåê Sitio: https://erp.batidospitaya.com"
        echo "üñ•Ô∏è Servidor: ${{ secrets.HOSTINGER_HOST }}:65002"